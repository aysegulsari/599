{% extends "reports/report_base.html" %}

{% block report_content %}
<div class="container">

    <div class="jumbotron">
        <h2 id=>{{report.name}}</h2>

        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default3">Keywords</span>
            </div>
            <input type="text" maxlength="50" class="form-control" aria-label="Default"
                   aria-describedby="inputGroup-sizing-default" id="keyword" name="keyword" disabled
                   value="{{report.keyword}}">
        </div>

        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default4">Tweet Count</span>
            </div>
            <input type="text" maxlength="50" class="form-control" aria-label="Default"
                   aria-describedby="inputGroup-sizing-default" id="count" name="count" disabled
                   value="{{report.tweet_count}}">
        </div>

        <!--
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default4">Get only tweets with hashtags</span>
            </div>
            <input type="text" maxlength="50" class="form-control" aria-label="Default"
                   aria-describedby="inputGroup-sizing-default" id="hashtag" name="hashtag" disabled
                   value="{{report.hashtag}}">
        </div>
	    -->

        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default">Language</span>
            </div>
            <input type="text" maxlength="50" class="form-control" aria-label="Default"
                   aria-describedby="inputGroup-sizing-default" id="language" name="language" disabled
                   value="{{report.language}}">
        </div>


        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default5">Time interval</span>
            </div>
            <input type="text" maxlength="50" class="form-control" aria-label="Default"
                   aria-describedby="inputGroup-sizing-default" value="{{report.time_interval}}" disabled>
        </div>

        <div>
            <button class="btn-warning" id='button' type="button"><span class="fa fa-plus"></span>Show/Hide Tweets
            </button>
            <button class="btn-warning" id='analyze_button' type="button"><span class="fa fa-plus"></span>Analyze
                Sentiments
            </button>
            <button class="btn-warning" id='draw_button' type="button"><span class="fa fa-plus"></span>Charts
            </button>
        </div>
        <br>
        <p id="name">{{report.name}}</p>
    </div>

    <br>
    <br>
    <br>
    <div class="input-group mb-3" id="datatable-div">
        <table id="datatable" class="display" style="width:100%">
            <thead>
            <tr>
                <th>Tweet ID</th>
                <th>Creation Date</th>
                <th>Tweet Text</th>
                <th>Language</th>
                <th>Retweet Count</th>
                <th>Like Count</th>
                <th>Hashtags</th>
                <th>Domain</th>
                <th>Entity</th>
                <th>Sentiment</th>
            </tr>
            </thead>
        </table>
    </div>
    <div class="input-group mb-3" >

    <div id="piechart"></div>
    <div id="piechart2"></div>
</div>

</div>


<script>
    window.onload = function (e) {
        document.getElementById("datatable").style.visibility = 'hidden'
        document.getElementById("datatable-div").style.visibility = 'hidden'
        document.getElementById("name").style.visibility = 'hidden'
        document.getElementById("piechart").style.visibility = 'hidden'
        document.getElementById("piechart2").style.visibility = 'hidden'
    }

    let tweets = {};
    let isDatatableFilled = false
    name = document.getElementById("name").innerHTML
    $("#button").click(function () {
        if (!isDatatableFilled) {
            tweets = $.ajax({
                type: 'POST',
                async: false,
                url: '{% url "reports:get_tweets" %}',
                dataType: 'json',
                data: {
                    'name': name,
                }
            }).responseJSON;
            document.getElementById("count").innerText = tweets['data'].length

            isDatatableFilled = true;
            $('#datatable').DataTable({
                destroy: true,
                searchPanes: {
                    threshold: 1,
                    columns: [1, 3, 4, 5, 6, 7, 8, 9]
                },
                columnDefs: [
                    {
                        targets: 6,
                        render: function (data, type, row) {
                            if (type === 'sp') {
                                return data.split(' , ')
                            }
                            return data;
                        },
                        searchPanes: {
                            orthogonal: 'sp'
                        }
                    }, {
                        targets: 7,
                        render: function (data, type, row) {
                            if (type === 'sp') {
                                return data.split(' , ')
                            }
                            return data;
                        },
                        searchPanes: {
                            orthogonal: 'sp'
                        }
                    }, {
                        targets: 8,
                        render: function (data, type, row) {
                            if (type === 'sp') {
                                return data.split(' , ')
                            }
                            return data;
                        },
                        searchPanes: {
                            orthogonal: 'sp'
                        }
                    }
                ],
                responsive: true,
                dom: '<"dtsp-verticalContainer"<"dtsp-verticalPanes"P>l<"dtsp-dataTable"frtip>>',
                "processing": true,
                data: tweets['data']
            });
        }

        if (document.getElementById("datatable").style.visibility == 'hidden') {
            document.getElementById("datatable").style.visibility = 'visible'
            document.getElementById("datatable-div").style.visibility = 'visible'

        } else {
            document.getElementById("datatable").style.visibility = 'hidden'
            document.getElementById("datatable-div").style.visibility = 'hidden'
        }
    });

    $("#analyze_button").click(function () {

        $.ajax({
            type: 'POST',
            async: true,
            url: '{% url "reports:analyze_tweets" %}',
            dataType: 'json',
            data: {
                'name': name,
            }
        });
    });

    $("#draw_button").click(function () {

        let graph_object = $.ajax({
            type: 'POST',
            async: false,
            url: '{% url "reports:draw_charts" %}',
            dataType: 'json',
            data: {
                'name': name,
            }
        }).responseJSON;

        drawChart("Sentiment analysis of all tweets", graph_object['data'][0][1], graph_object['data'][1][1], graph_object['data'][2][1])
        document.getElementById("piechart").style.visibility = 'visible'
        document.getElementById("piechart2").style.visibility = 'visible'
        //scroll to specific div when go to button is clicked
        let target = document.getElementById("piechart")
        var scrollContainer = target;
        do { //find scroll container
            scrollContainer = scrollContainer.parentNode;
            if (!scrollContainer) return;
            scrollContainer.scrollTop += 1;
        } while (scrollContainer.scrollTop == 0);

        var targetY = 0;
        do { //find the top of target relatively to the container
            if (target == scrollContainer) break;
            targetY += target.offsetTop;
        } while (target = target.offsetParent);

        scroll = function (c, a, b, i) {
            i++;
            if (i > 30) return;
            c.scrollTop = a + (b - a) / 30 * i;
            setTimeout(function () {
                scroll(c, a, b, i);
            }, 20);
        }
        // start scrolling
        scroll(scrollContainer, scrollContainer.scrollTop, targetY, 0);
    });
    // Load google charts
    google.charts.load('current', {'packages': ['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    // Draw the chart and set the chart values
    function drawChart(title, positive, negative, neutral) {
        var data = google.visualization.arrayToDataTable([
            ['sentiment','count'],
            ['positive', positive],
            ['negative', negative],
            ['neutral', neutral]
        ]);
        // Optional; add a title and set the width and height of the chart
        var options = {'title': title, 'width': 550, 'height': 400};

        // Display the chart inside the <div> element with id="piechart"
        var chart = new google.visualization.PieChart(document.getElementById('piechart'));
        var chart2 = new google.visualization.PieChart(document.getElementById('piechart2'));
        chart.draw(data, options);
        chart2.draw(data, options);
    }
</script>
{% endblock %}
