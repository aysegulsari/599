{% extends "reports/report_base.html" %}

<form>
    {% block report_content %}
    <div class="jumbotron jumbotron-fluid">
        <h2>Create Report</h2>
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default2">Report Name</span>
            </div>
            <input type="text" maxlength="50" class="form-control" aria-label="Default"
                   aria-describedby="inputGroup-sizing-default" id="name" name="name" required>
        </div>

        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default3">Keywords</span>
            </div>
            <div class="form-control tags" id="tags">
                <input type="text" class="labelinput">
                <input type="hidden" name="result" id="keyword" name="keyword" required>
            </div>
        </div>

        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default4">Tweet Count</span>
            </div>
            <input type="text" maxlength="50" class="form-control" aria-label="Default"
                   aria-describedby="inputGroup-sizing-default" id="count" name="count" required>
        </div>

        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default">Language</span>
            </div>
            <select class="form-control" id="language">
                <option value="en">en</option>
                <option value="tr">tr</option>
            </select>
        </div>

        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroup-sizing-default5">Time interval</span>
            </div>
            <input type="text" name="daterange" value="01/12/2021 - 01/16/2021" required>
        </div>

        <div>
            <button class="btn-warning" id='button' type="button"><span class="fa fa-plus"></span>Collect Tweets
            </button>
            <!-- <button class="btn-warning" id='button2' type="button"><span class="fa fa-plus"></span>Save Report
             </button> -->
        </div>
        <div class="jumbotron jumbotron-fluid">
            <br>
            <br>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <p id="note"> Please wait until tweets are loaded...</p>
                </div>
            </div>
            <br>
            <br>
            <div class="input-group mb-3">
                <table id="datatable" class="display" style="width:100%">
                    <thead>
                    <tr>
                        <th>Tweet ID</th>
                        <th>Creation Date</th>
                        <th>Tweet Text</th>
                        <th>Category</th>
                        <th>Sentiment</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th>Tweet ID</th>
                        <th>Creation Date</th>
                        <th>Tweet Text</th>
                        <th>Category</th>
                        <th>Sentiment</th>
                    </tr>
                    </tfoot>
                </table>
            </div>
</form>

<script>
    window.onload = function (e) {
        document.getElementById("datatable").style.visibility = 'hidden'
        //document.getElementById("button2").style.visibility = 'hidden'
        document.getElementById("note").style.visibility = 'hidden'
    }

    let startDate = '2021-01-12';
    let endDate = '2021-01-16';
    let tweets = [];
    let keyword = '';
    let count = '';
    let language = '';
    $(function () {
        $('input[name="daterange"]').daterangepicker({
            opens: 'left'
        }, function (start, end, label) {
            console.log("A new date selection was made: " + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
            startDate = start.format('YYYY-MM-DD');
            endDate = end.format('YYYY-MM-DD');
        });
    });

    $("#button").click(function () {
        document.body.style.cursor = "progress";
        document.getElementById("datatable").style.visibility = 'hidden'
        //document.getElementById("button2").style.visibility = 'hidden'

        keyword = document.getElementById("keyword").value;
        count = document.getElementById("count").value;
        language = $("#language").find('option:selected').val();
        let name = document.getElementById("name").value;

        if (keyword.length == 0 || count.length == 0 || name.length == 0) {
            alert('Please enter report name, keyword and tweet count!')
            document.body.style.cursor = "default";
        } else {
            alert('Please wait until tweets are loaded!')
            document.body.style.cursor = "progress";
            s
            document.getElementById("note").style.visibility = 'visible'
            document.getElementById("note").innerHTML = " Please wait until tweets are loaded..."

            tweets = $.ajax({
                type: 'POST',
                async: false,
                url: '{% url "reports:collect_tweets" %}',
                dataType: 'json',
                data: {
                    'keyword': keyword,
                    'name': name,
                    'count': count,
                    'start': startDate,
                    'end': endDate,
                    'language':language
                }
            }).responseJSON;
            document.body.style.cursor = "default";

            console.log(tweets)
            if (tweets['data'] == "no tweet") {
                document.getElementById("note").innerHTML = "No tweet found!Try different keywords"

            } else if (tweets['data'] == "report name exists") {
                document.getElementById("note").innerHTML = "Report name exist!Enter a different name"
            } else if (tweets['data'] == "report could not saved") {
                document.getElementById("note").innerHTML = "Report could not saved"
            } else {

                document.getElementById("note").innerHTML = "Tweets are loaded!"
                document.getElementById("datatable").style.visibility = 'visible'
                //document.getElementById("button2").style.visibility = 'visible'
                $('#datatable').DataTable({
                    destroy: true,
                    searchPanes: {
                        threshold: 1,
                        columns: [1, 3, 4]
                    },
                    responsive: true,
                    dom: '<"dtsp-verticalContainer"<"dtsp-verticalPanes"P>l<"dtsp-dataTable"frtip>>',
                    "processing": true,
                    data: tweets['data']
                });
            }
        }
    })
    ;


    $(function () {
        $('#tags').tagInput();
    });
    // Bootstrap 4
    $('#tags').tagInput({
        labelClass: "badge badge-success"
    });
</script>
{% endblock %}
